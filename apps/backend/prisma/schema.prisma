// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// 1. Profiles (사용자 프로필)
// =============================================
model Profile {
  id                 String   @id @db.Uuid
  email              String
  name               String?
  avatarUrl          String?  @map("avatar_url")
  role               String   @default("USER")
  plan               String   @default("FREE")
  credits            Int      @default(30)
  language           String   @default("ko")
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep     Int      @default(0) @map("onboarding_step")
  notificationEmail  Boolean  @default(true) @map("notification_email")
  notificationPush   Boolean  @default(true) @map("notification_push")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  chatSessions            ChatSession[]
  analysisJobs            AnalysisJob[]
  integrationNotion       IntegrationNotion?
  notionExports           NotionExport[]
  subscription            Subscription?
  creditTransactions      CreditTransaction[]
  temporaryPremiumAccess  TemporaryPremiumAccess[]
  dailyUsage              DailyUsage[]
  notifications           Notification[]
  pushTokens              PushToken[]
  userFeedback            UserFeedback[]

  @@map("profiles")
}

// =============================================
// 2. Chat Sessions (채팅 세션)
// =============================================
model ChatSession {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  title          String?
  notionPageId   String?  @map("notion_page_id")
  notionPageUrl  String?  @map("notion_page_url")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user     Profile       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
  analysisJobs AnalysisJob[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("chat_sessions")
}

// =============================================
// 3. Analysis Results (분석 결과)
// =============================================
model AnalysisResult {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  videoId              String   @map("video_id")
  videoUrl             String   @map("video_url")
  videoTitle           String?  @map("video_title")
  videoThumbnail       String?  @map("video_thumbnail")
  videoDurationSeconds Int?     @map("video_duration_seconds")
  mode                 String
  resultJson           Json?    @map("result_json")
  transcript           String?
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  chatMessages  ChatMessage[]
  analysisJobs  AnalysisJob[]
  notionExports NotionExport[]

  @@unique([videoId, mode], name: "analysis_results_video_id_mode_key")
  @@index([videoId])
  @@index([videoId, mode])
  @@map("analysis_results")
}

// =============================================
// 4. Chat Messages (채팅 메시지)
// =============================================
model ChatMessage {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  role          String
  type          String
  content       String?
  analysisRefId String?  @map("analysis_ref_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  session       ChatSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  analysisRef   AnalysisResult? @relation(fields: [analysisRefId], references: [id])

  @@index([sessionId])
  @@map("chat_messages")
}

// =============================================
// 5. Analysis Jobs (분석 작업)
// =============================================
model AnalysisJob {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  sessionId       String?   @map("session_id") @db.Uuid
  videoUrl        String    @map("video_url")
  videoId         String?   @map("video_id")
  mode            String
  status          String    @default("PENDING")
  creditsReserved Int       @default(0) @map("credits_reserved")
  resultId        String?   @map("result_id") @db.Uuid
  errorMessage    String?   @map("error_message")
  errorCode       String?   @map("error_code")
  progress        Int       @default(0)
  startedAt       DateTime? @map("started_at") @db.Timestamptz
  completedAt     DateTime? @map("completed_at") @db.Timestamptz
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user    Profile         @relation(fields: [userId], references: [id], onDelete: Cascade)
  session ChatSession?    @relation(fields: [sessionId], references: [id])
  result  AnalysisResult? @relation(fields: [resultId], references: [id])

  @@index([userId, status])
  @@index([status])
  @@map("analysis_jobs")
}

// =============================================
// 6. Integration Notion (Notion 연동)
// =============================================
model IntegrationNotion {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  encryptedToken String   @map("encrypted_token")
  tokenIv        String   @map("token_iv")
  workspaceId    String?  @map("workspace_id")
  workspaceName  String?  @map("workspace_name")
  workspaceIcon  String?  @map("workspace_icon")
  botId          String?  @map("bot_id")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("integration_notion")
}

// =============================================
// 7. Notion Exports (Notion 내보내기)
// =============================================
model NotionExport {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  analysisId    String    @map("analysis_id") @db.Uuid
  notionPageId  String    @map("notion_page_id")
  notionPageUrl String?   @map("notion_page_url")
  lastSyncedAt  DateTime? @map("last_synced_at") @db.Timestamptz
  syncVersion   Int       @default(1) @map("sync_version")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user     Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis AnalysisResult @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@unique([userId, analysisId])
  @@map("notion_exports")
}

// =============================================
// 8. Subscriptions (구독)
// =============================================
model Subscription {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  plan               String
  provider           String?
  customerId         String?   @map("customer_id")
  subscriptionId     String?   @map("subscription_id")
  status             String    @default("ACTIVE")
  currentPeriodStart DateTime? @map("current_period_start") @db.Timestamptz
  currentPeriodEnd   DateTime? @map("current_period_end") @db.Timestamptz
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================
// 9. Credit Transactions (크레딧 트랜잭션)
// =============================================
model CreditTransaction {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  amount        Int
  type          String
  description   String?
  referenceId   String?  @map("reference_id") @db.Uuid
  referenceType String?  @map("reference_type")
  balanceAfter  Int      @map("balance_after")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("credit_transactions")
}

// =============================================
// 10. System Prompts (시스템 프롬프트)
// =============================================
model SystemPrompt {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  content     String
  version     Int      @default(1)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([name, version])
  @@map("system_prompts")
}

// =============================================
// 11. Audit Logs (감사 로그)
// =============================================
model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?  @map("user_id") @db.Uuid
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id") @db.Uuid
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// =============================================
// 12. Webhook Events (Webhook 이벤트)
// =============================================
model WebhookEvent {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider          String
  eventId           String    @map("event_id")
  eventType         String    @map("event_type")
  payload           Json?
  signatureVerified Boolean   @default(false) @map("signature_verified")
  processedAt       DateTime? @map("processed_at") @db.Timestamptz
  errorMessage      String?   @map("error_message")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@unique([provider, eventId])
  @@index([provider, eventId])
  @@map("webhook_events")
}

// =============================================
// 13. Ad Configs (광고 설정)
// =============================================
model AdConfig {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  platform      String
  placementType String   @map("placement_type")
  position      String
  unitId        String   @map("unit_id")
  enabled       Boolean  @default(true)
  priority      Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([platform, position])
  @@index([platform])
  @@index([platform, enabled])
  @@map("ad_configs")
}

// =============================================
// 14. Ad Frequency Configs (광고 빈도 설정)
// =============================================
model AdFrequencyConfig {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  platform              String   @unique
  interstitialCooldownMs Int     @default(60000) @map("interstitial_cooldown_ms")
  maxAdsPerSession      Int      @default(10) @map("max_ads_per_session")
  feedAdInterval        Int      @default(5) @map("feed_ad_interval")
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("ad_frequency_configs")
}

// =============================================
// 15. Temporary Premium Access (임시 프리미엄)
// =============================================
model TemporaryPremiumAccess {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  grantedAt DateTime @default(now()) @map("granted_at") @db.Timestamptz
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  source    String
  isActive  Boolean  @default(true) @map("is_active")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("temporary_premium_access")
}

// =============================================
// 16. Daily Usage (일일 사용량)
// =============================================
model DailyUsage {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  date             DateTime @db.Date
  standardAnalyses Int      @default(0) @map("standard_analyses")
  deepAnalyses     Int      @default(0) @map("deep_analyses")
  chatMessages     Int      @default(0) @map("chat_messages")
  totalVideoMinutes Int     @default(0) @map("total_video_minutes")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_usage")
}

// =============================================
// 17. User Analytics (사용자 분석)
// =============================================
model UserAnalytics {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  sessionId  String?  @map("session_id")
  eventName  String   @map("event_name")
  properties Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([eventName])
  @@map("user_analytics")
}

// =============================================
// 18. Notifications (알림)
// =============================================
model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String
  title     String
  body      String
  data      Json?
  readAt    DateTime? @map("read_at") @db.Timestamptz
  sentAt    DateTime? @map("sent_at") @db.Timestamptz
  channel   String?
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// =============================================
// 19. Push Tokens (Push 토큰)
// =============================================
model PushToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String
  platform  String
  deviceId  String?  @map("device_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@map("push_tokens")
}

// =============================================
// 20. API Keys (API Key)
// =============================================
model ApiKey {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  keyHash    String    @map("key_hash")
  prefix     String
  scopes     String[]  @default([])
  isActive   Boolean   @default(true) @map("is_active")
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamptz
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  rotatedAt  DateTime? @map("rotated_at") @db.Timestamptz

  @@map("api_keys")
}

// =============================================
// 21. User Feedback (피드백)
// =============================================
model UserFeedback {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  type      String
  content   String
  metadata  Json?
  status    String   @default("NEW")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user Profile? @relation(fields: [userId], references: [id])

  @@map("user_feedback")
}
